<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bookhub.bookhub_back.mapper.StockStatisticsMapper">
<!-- 1. -->
    <select id="findTotalAmountByBranchAndType" resultType="Long">
        SELECT COALESCE(SUM(sl.amount), 0)
        FROM stock_logs sl
        JOIN branches br ON sl.branch_id = br.branch_id
        WHERE br.branch_id = #{branchId}
        AND sl.action_type = #{type}
        AND YEAR(sl.actioned_at) = #{year}
        AND MONTH(sl.actioned_at) = #{month}
    </select>

<!-- 2. -->
    <select id="findTimeStockStatisticsByYear" resultType="TimeStockChartResponseDto">
        SELECT br.branch_name,
        MONTH(sl.actioned_at) as month,
        SUM(CASE WHEN sl.action_type = 'IN' THEN sl.amount ELSE 0 END) AS isAmount,
        SUM(CASE WHEN sl.action_type = 'LOSS' THEN sl.amount ELSE 0 END) AS lossAmount
        FROM stock_logs sl
        JOIN branches br ON br.branch_id = sl.branch_id
        WHERE YEAR(sl.actioned_at) = #{year}
        GROUP BY br.branch_name, month
        ORDER BY month
    </select>

<!-- 3. -->
    <select id="findZeroStockStatistics" resultType="ZeroStockResponseDto">
        SELECT br.branch_name AS branchName,
               COUNT(*) AS zeroStockCount
        FROM stocks s
        JOIN branches br ON br.branch_id = s.branch_id
        WHERE s.book_amount = 0
        GROUP BY branchName
    </select>

<!-- 4. -->
    <select id="findCategoryStockByBranch" resultType="CategoryStockResponseDto">
        SELECT bc.category_name AS categoryName,
               SUM(s.book_amount) AS totalAmount
        FROM stocks s
        JOIN books b ON b.book_isbn = s.book_isbn
        JOIN book_categories bc ON bc.category_id = b.category_id
        JOIN branches br ON br.branch_id = s.branch_id
        WHERE br.branch_name = #{branchName}
        GROUP BY categoryName
        ORDER BY totalAmount DESC
    </select>
</mapper>